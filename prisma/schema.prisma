generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String                  @id @default(cuid())
  email              String                  @unique
  password           String
  name               String
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  createdBy          String?
  invoices           Invoice[]
  roles              UserRole[]
  creator            User?                   @relation("UserCreator", fields: [createdBy], references: [id])
  createdUsers       User[]                  @relation("UserCreator")
  performanceTargets PerformanceTarget[]
  notifications      Notification[]
  issuedCreditNotes  CreditNote[]            @relation("CreditNotesIssued")
  appliedCreditNotes CreditNoteApplication[] @relation("CreditNoteAppliedBy")

  @@map("users")
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  permissions String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  users       UserRole[]

  @@map("roles")
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Category {
  id          String    @id @default(cuid())
  title       String    @unique
  description String?
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("categories")
}

model Product {
  id                String        @id @default(cuid())
  name              String
  price             Decimal       @db.Decimal(10, 2)
  description       String?
  categoryId        String
  stockQuantity     Int           @default(0)
  lowStockThreshold Int           @default(0)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  invoiceItems      InvoiceItem[]
  category          Category      @relation(fields: [categoryId], references: [id])

  @@map("products")
}

model Patient {
  id            String        @id @default(cuid())
  patientId     Int           @default(autoincrement())
  patientName   String
  patientMobile String        @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  invoices      Invoice[]
  appointments  Appointment[]
  creditNotes   CreditNote[]

  @@map("patients")
}

model Appointment {
  id              String   @id @default(cuid())
  patientId       String
  appointmentDate DateTime
  status          String   @default("scheduled")
  reason          String?
  notes           String?
  branch          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  patient         Patient  @relation(fields: [patientId], references: [id])
  invoice         Invoice?

  @@map("appointments")
}

model Invoice {
  id                   String                  @id @default(cuid())
  invoiceNo            String                  @unique
  status               String                  @default("unpaid")
  subtotal             Decimal                 @default(0) @db.Decimal(10, 2)
  discount             Decimal                 @default(0) @db.Decimal(10, 2)
  discountType         String                  @default("percentage")
  discountAmount       Decimal                 @default(0) @db.Decimal(10, 2)
  totalAmount          Decimal                 @db.Decimal(10, 2)
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  createdBy            String
  patientId            String
  branch               String?
  corporateId          String?
  paidAmount           Decimal                 @default(0) @db.Decimal(10, 2)
  creditAppliedAmount  Decimal                 @default(0) @db.Decimal(10, 2)
  refundedAmount       Decimal                 @default(0) @db.Decimal(10, 2)
  appointmentId        String?                 @unique
  items                InvoiceItem[]
  user                 User                    @relation(fields: [createdBy], references: [id])
  patient              Patient                 @relation(fields: [patientId], references: [id])
  appointment          Appointment?            @relation(fields: [appointmentId], references: [id])
  creditNotes          CreditNote[]
  appliedCreditRecords CreditNoteApplication[] @relation("AppliedInvoiceCreditApplications")

  @@map("invoices")
}

model InvoiceItem {
  id             String   @id @default(cuid())
  invoiceId      String
  productId      String?
  productName    String
  quantity       Int
  unitPrice      Decimal  @db.Decimal(10, 2)
  total          Decimal  @db.Decimal(10, 2)
  isManual       Boolean  @default(false)
  discount       Decimal  @default(0) @db.Decimal(10, 2)
  discountAmount Decimal  @default(0) @db.Decimal(10, 2)
  discountType   String   @default("percentage")
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product        Product? @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model CreditNote {
  id              String                  @id @default(cuid())
  creditNo        String                  @unique
  invoiceId       String
  patientId       String
  issuedBy        String
  type            String
  reason          String?
  notes           String?
  status          String                  @default("open")
  totalAmount     Decimal                 @db.Decimal(10, 2)
  remainingAmount Decimal                 @db.Decimal(10, 2)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  invoice         Invoice                 @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  patient         Patient                 @relation(fields: [patientId], references: [id])
  issuedByUser    User                    @relation("CreditNotesIssued", fields: [issuedBy], references: [id])
  applications    CreditNoteApplication[]
  history         CreditNoteHistory[]

  @@index([invoiceId])
  @@index([patientId])
  @@map("credit_notes")
}

model CreditNoteApplication {
  id               String     @id @default(cuid())
  creditNoteId     String
  appliedInvoiceId String
  appliedAmount    Decimal    @db.Decimal(10, 2)
  appliedBy        String
  createdAt        DateTime   @default(now())
  creditNote       CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  appliedInvoice   Invoice    @relation("AppliedInvoiceCreditApplications", fields: [appliedInvoiceId], references: [id], onDelete: Cascade)
  appliedByUser    User       @relation("CreditNoteAppliedBy", fields: [appliedBy], references: [id])

  @@index([creditNoteId])
  @@index([appliedInvoiceId])
  @@map("credit_note_applications")
}

model CreditNoteHistory {
  id           String     @id @default(cuid())
  creditNoteId String
  action       String
  actorId      String?
  metadata     Json?
  createdAt    DateTime   @default(now())
  creditNote   CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)

  @@index([creditNoteId])
  @@map("credit_note_history")
}

model Counter {
  id    String @id @default(cuid())
  name  String @unique
  value Int    @default(0)

  @@map("counters")
}

model PerformanceTarget {
  id            String   @id @default(cuid())
  name          String?
  periodType    String
  periodStart   DateTime
  periodEnd     DateTime
  branch        String?
  team          String?
  revenueTarget Decimal  @default(0) @db.Decimal(12, 2)
  profitTarget  Decimal  @default(0) @db.Decimal(12, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  notes         String?
  creator       User?    @relation(fields: [createdBy], references: [id])

  @@map("performance_targets")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String?
  data      Json?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}
